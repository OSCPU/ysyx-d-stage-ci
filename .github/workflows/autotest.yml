name: Auto-test Workflow

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  parse:
    runs-on: ubuntu-22.04
    outputs:
      STUID:  ${{ steps.parse.outputs.STUID }}
      REPO:   ${{ steps.parse.outputs.REPO }}
      BRANCH: ${{ steps.parse.outputs.BRANCH }}
      MAKEJOBS: ${{ steps.parse.outputs.MAKEJOBS }}
      COMMENT_ID: ${{ steps.comment-id.outputs.COMMENT_ID }}
    steps:
      - name: Print issue details
        run: |
          echo "üÜï New Issue Created"
          echo "---------------------"
          echo "üìå Title: ${{ github.event.issue.title }}"
          echo "üë§ Author: ${{ github.event.issue.user.login }}"
          echo "üîó URL: ${{ github.event.issue.html_url }}"
          echo ""
          echo "üìù Body Content:"
          echo "${{ github.event.issue.body }}"  # Áõ¥Êé•ËæìÂá∫issueÊ≠£Êñá
      - name: Parse information
        id: parse
        run: |
          STUID=$(echo "${{ github.event.issue.body }}" | sed -n -e '3p')
          REPO=$(echo "${{ github.event.issue.body }}" | sed -n -e '7p')
          BRANCH=$(echo "${{ github.event.issue.body }}" | sed -n -e '11p')
          echo "STUID=$STUID" >> $GITHUB_OUTPUT
          echo "REPO=$REPO" >> $GITHUB_OUTPUT
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT

          sudo timedatectl set-timezone Asia/Shanghai
          DATE=`date +"%F %T.%N"`
          COMMENT=$(echo "${{ github.event.issue.body }}" | sed -n -e '15p')
          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          echo "DATE=$DATE" >> $GITHUB_OUTPUT
          echo "COMMENT=$COMMENT" >> $GITHUB_OUTPUT
          echo "RUN_URL=$RUN_URL" >> $GITHUB_OUTPUT

          MAKEJOBS=1
          if echo "${{ github.event.issue.body }}" | sed -n -e '19p' | grep '^- \[ \] ' ; then
            MAKEJOBS=`nproc`
          fi
          echo "MAKEJOBS=$MAKEJOBS" >> $GITHUB_OUTPUT
      - name: Comment the issue
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Workflow starts at ${{ steps.parse.outputs.DATE }}
            Comment - ${{ steps.parse.outputs.COMMENT }}
            Workflow URL - ${{ steps.parse.outputs.RUN_URL }}
      - name: Find Comment
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.issue.number }}
          comment-author: 'github-actions[bot]'
          body-includes: Workflow starts at ${{ steps.parse.outputs.DATE }}
      - name: Export comment ID
        id: comment-id
        run: |
          COMMENT_ID=${{ steps.fc.outputs.comment-id }}
          echo "COMMENT_ID=$COMMENT_ID" >> $GITHUB_OUTPUT

  setup:
    needs: parse
    runs-on: ubuntu-22.04
    outputs:
      cache-key: ${{ steps.set-cache.outputs.cache-key }}
      YSYX_HOME: ${{ steps.set-ysyx-home.outputs.YSYX_HOME }}
      VFILE:     ${{ steps.vfilename.outputs.VFILE }}
      MAKEFLAGS: ${{ steps.set-env.outputs.MAKEFLAGS }}
    steps:
      - name: Set Git user and email
        run: |
          git config --global user.email "ci@ysyx.org"
          git config --global user.name "ysyx-ci"

      - name: Set student ID as environment variable
        run: |
          echo "STUID=${{ needs.parse.outputs.STUID }}" >> $GITHUB_ENV

      - name: Check branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Ëá™Âä®Êã•ÊúâÂΩìÂâç‰ªìÂ∫ìËØªÂèñÊùÉÈôê
        run: |
          if gh api "repos/${{ github.repository }}/branches" --jq '.[].name' | grep "ysyx_$STUID" ; then
            echo "Branch ysyx_$STUID has been submitted before. Overwriting is not allowed. Abort."
            false
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set YSYX_HOME
        id: set-ysyx-home
        run: |
          TEMP_DIR=$(mktemp -d -p .)
          cd $TEMP_DIR
          YSYX_HOME=$(pwd)/ysyx-workbench
          echo "YSYX_HOME=$YSYX_HOME" >> $GITHUB_ENV
          echo "YSYX_HOME=$YSYX_HOME" >> $GITHUB_OUTPUT

      - name: Generate cache key
        id: set-cache
        run: |
          echo "cache-key=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Cache repo and tools
        uses: actions/cache@v3
        id: setup-cache
        with:
          path: |
            ${{ steps.set-ysyx-home.outputs.YSYX_HOME }}
            oss-cad-suite
            ~/.local
            ~/.cache/mill
          key: ${{ runner.os }}-dir-${{ steps.set-cache.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-dir-

      - name: Clone target repo
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          echo "Workflow cache miss..."

          mkdir -p $YSYX_HOME
          cd $YSYX_HOME/..
          git clone --depth 1 -b ${{ needs.parse.outputs.BRANCH }} ${{ needs.parse.outputs.REPO }} ysyx-workbench

      - name: Create orphan branch
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          cd $YSYX_HOME
          git checkout --orphan tmp-ci
          git commit -m "orphan branch created by CI"
          cd ..
          git clone -b tmp-ci file://$YSYX_HOME ysyx-workbench-ci
          rm -rf ysyx-workbench
          mv ysyx-workbench-ci ysyx-workbench
          cd $YSYX_HOME
          git remote set-url origin ${{ needs.parse.outputs.REPO }}

      - name: Check student ID
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          cd $YSYX_HOME
          stuid=$(grep -E -o "STUID = ysyx_[0-9]{8}" Makefile)
          if [[ $stuid == "" ]]; then
            echo "Missing STUID in Makefile (format: STUID = ysyx_XXXXXXXX). Abort."
            false
          fi
          stuid=$(echo $stuid | grep -E -o "[0-9]{8}$")
          if [[ $stuid != $STUID ]]; then
            echo "STUID in Makefile($stuid) is different from the one filled in the form($STUID). Abort."
            false
          fi

      # - name: Check student ID in whitelist #ÁôΩÂêçÂçï
      #   if: steps.cache-dir.outputs.cache-hit != 'true'
      #   run: |
      #     wget https://raw.githubusercontent.com/OSCPU/ysyx-workbench/whitelist/whitelist.txt
      #     if ! grep -o $STUID whitelist.txt 2> /dev/null ; then
      #       echo "$STUID is not in whitelist. Abort."
      #       false
      #     fi

      # - name: Parse git log generated by git tracer #ÁªüËÆ°trancer
      #   id: tracer
      #   if: steps.cache-dir.outputs.cache-hit != 'true'
      #   run: |
      #     cd $YSYX_HOME
      #     git fetch origin tracer-ysyx:tracer-ysyx
      #     git log tracer-ysyx --author='tracer-ysyx <tracer@ysyx.org>' --grep="$STUID" --oneline > log.txt

      #     NR_COMPILE_NEMU=`grep "compile NEMU" log.txt | wc -l`
      #     NR_RUN_NEMU=`grep "run NEMU" log.txt | wc -l`
      #     NR_GDB_NEMU=`grep "gdb NEMU" log.txt | wc -l`
      #     NR_SIM_RTL=`grep "sim RTL" log.txt | wc -l`
      #     echo "NR_COMPILE_NEMU=$NR_COMPILE_NEMU" >> $GITHUB_OUTPUT
      #     echo "NR_RUN_NEMU=$NR_RUN_NEMU" >> $GITHUB_OUTPUT
      #     echo "NR_GDB_NEMU=$NR_GDB_NEMU" >> $GITHUB_OUTPUT
      #     echo "NR_SIM_RTL=$NR_SIM_RTL" >> $GITHUB_OUTPUT

      #     if [[ $NR_COMPILE_NEMU -eq 0 ]]; then
      #       echo "The times of compiling NEMU is 0. Abort"
      #       false
      #     fi
      #     if [[ $NR_RUN_NEMU -eq 0 ]]; then
      #       echo "The times of running NEMU is 0. Abort"
      #       false
      #     fi
      #     if [[ $NR_SIM_RTL -eq 0 ]]; then
      #       echo "The times of RTL simulation is 0. Abort"
      #       false
      #     fi

      #     rm log.txt

      - name: Comment the issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          comment-id: ${{ needs.parse.outputs.COMMENT_ID }}
          body: |
            +++++ tracer-ysyx +++++
            compile NEMU - ${{ steps.tracer.outputs.NR_COMPILE_NEMU }}
            run NEMU - ${{ steps.tracer.outputs.NR_RUN_NEMU }}
            gdb NEMU - ${{ steps.tracer.outputs.NR_GDB_NEMU }}
            sim RTL - ${{ steps.tracer.outputs.NR_SIM_RTL }}
            +++++++++++++++++++++++
          edit-mode: append

      - name: Set environment variables
        id: set-env
        run: |
          cd $YSYX_HOME
          NEMU_HOME="`pwd`/nemu"
          AM_HOME="`pwd`/abstract-machine"
          NAVY_HOME="`pwd`/navy-apps"
          NPC_HOME="`pwd`/npc"
          NVBOARD_HOME="`pwd`/nvboard"

          echo "NEMU_HOME=$NEMU_HOME" >> $GITHUB_ENV
          echo "AM_HOME=$AM_HOME" >> $GITHUB_ENV
          echo "NAVY_HOME=$NAVY_HOME" >> $GITHUB_ENV
          echo "NPC_HOME=$NPC_HOME" >> $GITHUB_ENV
          echo "NVBOARD_HOME=$NVBOARD_HOME" >> $GITHUB_ENV

          MAKEFLAGS="-j${{ needs.parse.outputs.MAKEJOBS }}"
          echo "MAKEFLAGS=$MAKEFLAGS" >> $GITHUB_ENV
          echo "MAKEFLAGS=$MAKEFLAGS" >> $GITHUB_OUTPUT

      - name: Check the version of AM
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          if [[ ! -e $AM_HOME/tools/insert-arg.py ]] ; then
            URL="https://github.com/NJU-ProjectN/abstract-machine/commit/c52a41181f8ea5d0e970008e51f58867a3ce65bb"
            echo "$AM_HOME/tools/insert-arg.py does not exist. Abort."
            echo "You may use AM with the version older than May, 2024."
            echo "Please refer to $URL to apply the patch to AM. After that, the CI flow can insert mainargs to the binary by the python script."
            false
          fi

          sed -i -e 's/MAINARGS_PLACEHOLDER = .*/MAINARGS_PLACEHOLDER = the_insert-arg_rule_in_Makefile_will_insert_mainargs_here/' $AM_HOME/scripts/platform/npc.mk

      - name: Disable git tracer
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          cd $YSYX_HOME
          echo ".git_commit:" >> Makefile
          echo -e "\t@echo git tracer is disabled" >> Makefile

      # - name: Check patch size #Ë°•‰∏ÅÂ§ßÂ∞èÊ£ÄÊü•
      #   if: steps.cache-dir.outputs.cache-hit != 'true'
      #   run: |
      #     SIZE=`du -sb $YSYX_HOME/patch | grep -o '^[0-9]*'`
      #     SIZE_LIMIT=1048576 # 1MB
      #     if [[ $SIZE -gt $SIZE_LIMIT ]] ; then
      #       echo "Patch size($SIZE) is larger than the limit($SIZE_LIMIT)."
      #       false
      #     fi

      - name: Clone other repos
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          cd $YSYX_HOME
          git clone --depth 1 -b ci https://github.com/NJU-ProjectN/am-kernels
          git clone --depth 1 -b no-gui https://github.com/NJU-ProjectN/nvboard
          git clone --depth 1 -b ysyx6 https://github.com/OSCPU/ysyxSoC
          git clone --depth 1 https://github.com/NJU-ProjectN/fceux-am
          git clone --depth 1 https://github.com/NJU-ProjectN/riscv-arch-test-am
#          git clone --depth 1 https://github.com/NJU-ProjectN/rt-thread-am


#          cd rt-thread-am #Â∫îÁî®Ë°•‰∏Å
#          git am $YSYX_HOME/patch/rt-thread-am/*
#          cd $YSYX_HOME
#
#          cd ysyxSoC
#          git am $YSYX_HOME/patch/ysyxSoC/*

      - name: Clean up
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          make -C $NEMU_HOME clean
          make -C $AM_HOME clean-all
          make -C $NPC_HOME clean

      - name: Setup tools
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/YosysHQ/oss-cad-suite-build/releases/download/2025-11-24/oss-cad-suite-linux-x64-20251124.tgz
          tar xf oss-cad-suite-linux-x64-20251124.tgz
          OSS_CAD_SUITE_BIN_PATH=`pwd`/oss-cad-suite/bin
          echo "PATH=$PATH:$OSS_CAD_SUITE_BIN_PATH" >> $GITHUB_ENV

          mkdir -p ~/.local/bin
          MILL_VERSION=0.11.13
          if [[ -e $YSYX_HOME/npc/.mill-version ]]; then
            MILL_VERSION=`cat $YSYX_HOME/npc/.mill-version`
          fi
          echo "Downloading mill with version $MILL_VERSION"
          sh -c "curl -L https://github.com/com-lihaoyi/mill/releases/download/$MILL_VERSION/$MILL_VERSION > ~/.local/bin/mill && chmod +x ~/.local/bin/mill"
          mill --version

#      - name: Generate verilog for NPC #chiselÁîüÊàêverilog
#        if: steps.cache-dir.outputs.cache-hit != 'true'
#        run: |
#          touch $NPC_HOME/.timestamp
#          make -C $NPC_HOME verilog
      - name: Debug before check
        run: |
          echo "=== Ë∞ÉËØï‰ø°ÊÅØ ==="
          echo "NPC_HOME: $NPC_HOME"
          echo "STUID: $STUID"
          echo "ÂΩìÂâçÁõÆÂΩï: $(pwd)"
          
          echo -e "\n=== ÁõÆÂΩïÁªìÊûÑ ==="
          ls -la $NPC_HOME/
          
          echo -e "\n=== build ÁõÆÂΩï ==="
          ls -la $NPC_HOME/build/ 2>/dev/null || echo "build/ ‰∏çÂ≠òÂú®"
          
          echo -e "\n=== ÊâÄÊúâ Verilog Êñá‰ª∂ ==="
          find $NPC_HOME -name "*.v" -o -name "*.sv" 2>/dev/null | head -20
          
          echo -e "\n=== .timestamp Êñá‰ª∂ ==="
          ls -la $NPC_HOME/.timestamp 2>/dev/null || echo ".timestamp ‰∏çÂ≠òÂú®"

      - name: Copy first Verilog file to build #copyÁ¨¨‰∏Ä‰∏™verilogÊñá‰ª∂Âà∞buildÁõÆÂΩï
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          mkdir -p $NPC_HOME/build
          
          # Êü•ÊâæÁ¨¨‰∏Ä‰∏™Êñá‰ª∂
          first_file=$(find $NPC_HOME -name "ysyx_*.v" -o -name "*ysyx_.sv" 2>/dev/null | head -1)
          
          if [ -z "$first_file" ]; then
            echo "‚ùå Êú™ÊâæÂà∞‰ªª‰Ωï Verilog Êñá‰ª∂"
            exit 1
          fi
          
          echo "ÊâæÂà∞Êñá‰ª∂: $first_file"
          cp "$first_file" $NPC_HOME/build/
          echo "‚úÖ Â∑≤Â§çÂà∂: $(basename "$first_file")"
          
          # È™åËØÅ
          echo "build ÁõÆÂΩïÂÜÖÂÆπ:"
          ls -la $NPC_HOME/build/

      - name: Debug before check
        run: |
          echo "=== Ë∞ÉËØï‰ø°ÊÅØ ==="
          echo "NPC_HOME: $NPC_HOME"
          echo "STUID: $STUID"
          echo "ÂΩìÂâçÁõÆÂΩï: $(pwd)"
          
          echo -e "\n=== ÁõÆÂΩïÁªìÊûÑ ==="
          ls -la $NPC_HOME/
          
          echo -e "\n=== build ÁõÆÂΩï ==="
          ls -la $NPC_HOME/build/ 2>/dev/null || echo "build/ ‰∏çÂ≠òÂú®"
          
          echo -e "\n=== ÊâÄÊúâ Verilog Êñá‰ª∂ ==="
          find $NPC_HOME -name "*.v" -o -name "*.sv" 2>/dev/null | head -20
          
          echo -e "\n=== .timestamp Êñá‰ª∂ ==="
          ls -la $NPC_HOME/.timestamp 2>/dev/null || echo ".timestamp ‰∏çÂ≠òÂú®"
          
      - name: Check verilog file name
        if: steps.cache-dir.outputs.cache-hit != 'true'
        id: vfilename
        run: |
          FILE_SV=$NPC_HOME/build/ysyx_$STUID.sv
          FILE_V=$NPC_HOME/build/ysyx_$STUID.v
          if [[ -f $FILE_SV ]]; then
            echo "Find $FILE_SV"
            VFILE=$FILE_SV
          elif [[ -f $FILE_V ]]; then
            echo "Find $FILE_V"
            VFILE=$FILE_V
          else
            echo "$FILE_SV or $FILE_V does not exist. Abort."
            false
          fi

          if [[ $NPC_HOME/.timestamp -nt $VFILE ]]; then
            echo "$VFILE is older than .timestamp. Abort."
            false
          fi

          echo "VFILE=$VFILE" >> $GITHUB_OUTPUT

      - name: Check verilog top module name
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          VFILE=${{ steps.vfilename.outputs.VFILE }}
          STR=`cat $VFILE | tr '\n' ' ' | grep -E "module\s+ysyx_$STUID" 2> /dev/null`
          if [[ $STR == "" ]]; then
            echo "Can not find module ysyx_$STUID in $VFILE. Abort."
            false
          fi

      - name: Check verilog clock edge
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          VFILE=${{ steps.vfilename.outputs.VFILE }}
          if grep "negedge" $VFILE; then
            echo "$VFILE contains negedge. Abort."
            false
          fi

      - name: Generate verilog for ysyxSoC
        if: steps.cache-dir.outputs.cache-hit != 'true'
        run: |
          sed -i -e 's+git@github.com:+https://github.com/+' $YSYX_HOME/ysyxSoC/.gitmodules
          make -C $YSYX_HOME/ysyxSoC dev-init
          make -C $YSYX_HOME/ysyxSoC verilog

      - name: Upload verilog file
        uses: actions/upload-artifact@v4
        with:
          name: verilog
          path: ${{ steps.vfilename.outputs.VFILE }}

      - name: Replace student ID in ysyxSoCFull.v
        run: |
          echo "ÊõøÊç¢ ysyxSoCFull.v ‰∏≠ÁöÑÂ≠¶Âè∑..."
          
          # Êñá‰ª∂Ë∑ØÂæÑ
          FILE_PATH="$YSYX_HOME/ysyxSoC/ready-to-run/D-stage/ysyxSoCFull.v"
          
          if [ ! -f "$FILE_PATH" ]; then
            echo "‚ùå Êñá‰ª∂‰∏çÂ≠òÂú®: $FILE_PATH"
            echo "ÂΩìÂâçÁõÆÂΩïÁªìÊûÑ:"
            find "$YSYX_HOME" -name "ysyxSoCFull.v" 2>/dev/null
            exit 1
          fi
          
          echo "ÂéüÂßãÊñá‰ª∂: $FILE_PATH"
          echo "Â≠¶Âè∑: $STUID"
          
          # Â§á‰ªΩÂéüÊñá‰ª∂
          cp "$FILE_PATH" "$FILE_PATH.bak"
          
          # ÊõøÊç¢ ysyx_00000000 ‰∏∫ ysyx_Â≠¶Âè∑
          sed -i "s/ysyx_00000000/ysyx_$STUID/g" "$FILE_PATH"
          
          echo "‚úÖ ÊõøÊç¢ÂÆåÊàê"
          
          # È™åËØÅÊõøÊç¢
          echo -e "\n=== È™åËØÅÊõøÊç¢ÁªìÊûú ==="
          echo "ÂåπÈÖçË°åÊï∞:"
          grep -c "ysyx_$STUID" "$FILE_PATH"
          
          echo -e "\nÁ§∫‰æãË°å:"
          grep "ysyx_$STUID" "$FILE_PATH" | head -5
          
          echo -e "\nÂéüÂßãÊñá‰ª∂Â§á‰ªΩÂú®: $FILE_PATH.bak"

      - name: Fix permissions for minirv tools
        run: |
          echo "‰øÆÂ§ç minirv Â∑•ÂÖ∑ÈìæÊùÉÈôê..."
          
          MINIRV_DIR="$YSYX_HOME/abstract-machine/tools/minirv"
          
          if [ ! -d "$MINIRV_DIR" ]; then
            echo "‚ùå ÁõÆÂΩï‰∏çÂ≠òÂú®: $MINIRV_DIR"
            echo "ÂΩìÂâçÁõÆÂΩïÁªìÊûÑ:"
            find "$YSYX_HOME" -name "*minirv*" 2>/dev/null | head -10
            exit 1
          fi
          
          echo "minirv Â∑•ÂÖ∑ÁõÆÂΩï: $MINIRV_DIR"
          ls -la "$MINIRV_DIR/"
          
          # Ë¶Å‰øÆÂ§çÁöÑÊñá‰ª∂
          FILES=("minirv-gcc" "minirv-g++" "minirv-common.sh")
          
          for file in "${FILES[@]}"; do
            FILE_PATH="$MINIRV_DIR/$file"
            
            if [ -f "$FILE_PATH" ]; then
              echo -e "\nÂ§ÑÁêÜ: $file"
              echo "ÂΩìÂâçÊùÉÈôê:"
              ls -la "$FILE_PATH"
              
              # Ê∑ªÂä†ÊâßË°åÊùÉÈôê
              chmod +x "$FILE_PATH"
              
              echo "‰øÆÂ§çÂêéÊùÉÈôê:"
              ls -la "$FILE_PATH"
              
              # È™åËØÅ
              if [ -x "$FILE_PATH" ]; then
                echo "‚úÖ ÊâßË°åÊùÉÈôêÂ∑≤Ê∑ªÂä†"
              else
                echo "‚ùå Ê∑ªÂä†ÊùÉÈôêÂ§±Ë¥•"
              fi
            else
              echo "‚ùå Êñá‰ª∂‰∏çÂ≠òÂú®: $FILE_PATH"
            fi
          done
          
#      - name: Install Capstone
#        run: |
#          echo "ÂÆâË£Ö Capstone ÂèçÊ±áÁºñÂ∫ì..."
#          
#          # Ubuntu/Debian
#          sudo apt-get update
#          sudo apt-get install -y libcapstone-dev
#          
#          # È™åËØÅÂÆâË£Ö
#          echo "È™åËØÅÂÆâË£Ö:"
#          pkg-config --modversion capstone 2>/dev/null || echo "‰ΩøÁî® pkg-config Ê£ÄÊü•Â§±Ë¥•"
#          
#          # Êü•ÊâæÂ§¥Êñá‰ª∂
#          echo "Êü•Êâæ capstone.h:"
#          find /usr -name "capstone.h" 2>/dev/null | head -5
#          
#          # Êü•ÊâæÂ∫ìÊñá‰ª∂
#          echo "Êü•Êâæ libcapstone:"
#          find /usr -name "*capstone*" 2>/dev/null | head -10
  time:
    needs: setup
    runs-on: ubuntu-22.04
    env:
      # ÈÖçÁΩÆÂèòÈáè
      EXPECTED_OUTPUT: "GMT"  # Ë¶ÅÊ£ÄÊµãÁöÑËæìÂá∫Â≠óÁ¨¶‰∏≤
      OUTPUT_CASE_SENSITIVE: true  # ÊòØÂê¶Âå∫ÂàÜÂ§ßÂ∞èÂÜô
      TIMEOUT_SECONDS: 600  # ÊÄª‰ΩìË∂ÖÊó∂Êó∂Èó¥ÔºàÁßíÔºâ
      LOG_LINES_ON_FAILURE: 50  # Â§±Ë¥•Êó∂ÊòæÁ§∫ÁöÑÊúÄÂêéÊó•ÂøóË°åÊï∞
      LOG_LINES_ON_TIMEOUT: 100  # Ë∂ÖÊó∂Êó∂ÊòæÁ§∫ÁöÑÊúÄÂêéÊó•ÂøóË°åÊï∞
      MONITOR_SECONDS: 10  # ÁõëÊéßÊó∂ÈïøÔºàÁßíÔºâ
      EXPECTED_COUNT_RANGE: "9 10 11"  # ÊúüÊúõÁöÑËæìÂá∫Êï∞ÈáèËåÉÂõ¥

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: time
        run: |
          KEY=$(head -c 5 /dev/urandom | base32)
          echo "ÂºÄÂßãËøêË°åtimeÊµãËØï..."
          echo "ÈÖçÁΩÆ:"
          echo "  - È¢ÑÊúüËæìÂá∫: '$EXPECTED_OUTPUT'"
          echo "  - Â§ßÂ∞èÂÜôÊïèÊÑü: $OUTPUT_CASE_SENSITIVE"
          echo "  - ÊÄª‰ΩìË∂ÖÊó∂Êó∂Èó¥: ${TIMEOUT_SECONDS}Áßí"
          echo "  - ÁõëÊéßÊó∂Èïø: ${MONITOR_SECONDS}Áßí"
          echo "  - ÊúüÊúõËæìÂá∫Êï∞Èáè: ${EXPECTED_COUNT_RANGE}‰∏™"
          
          # ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂Êñá‰ª∂Êù•ËÆ∞ÂΩïËæìÂá∫
          LOGFILE="/tmp/npc_time_$$.log"
          
          # Ê†πÊçÆÂ§ßÂ∞èÂÜôÊïèÊÑüËÆæÁΩÆÈÄâÊã©grepÈÄâÈ°π
          if [ "$OUTPUT_CASE_SENSITIVE" = "true" ]; then
            GREP_OPTIONS=""
            echo "Ê£ÄÊµãÊ®°Âºè: Âå∫ÂàÜÂ§ßÂ∞èÂÜô"
          else
            GREP_OPTIONS="-i"
            echo "Ê£ÄÊµãÊ®°Âºè: ‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜô"
          fi
          
          echo -e "\n=== ÂêØÂä®‰ªøÁúüËøõÁ®ã ==="
          # ‰ΩøÁî®timeoutÂëΩ‰ª§ËøêË°å‰ªøÁúü
          timeout $TIMEOUT_SECONDS make ARCH=minirv-npc -C $YSYX_HOME/am-kernels/tests/am-tests run mainargs=t 2>&1 | tee "$LOGFILE" &
          echo txt:timeout $TIMEOUT_SECONDS make ARCH=native -C $YSYX_HOME/am-kernels/tests/am-tests run mainargs=t 2>&1 | tee "$LOGFILE" &
          SIM_PID=$!
          
          echo "‰ªøÁúüËøõÁ®ãPID: $SIM_PID"
          
          # Á≠âÂæÖÁ¨¨‰∏Ä‰∏™È¢ÑÊúüËæìÂá∫Âá∫Áé∞
          echo -e "\n=== Á≠âÂæÖÁ¨¨‰∏Ä‰∏™ '$EXPECTED_OUTPUT' ËæìÂá∫ ==="
          FIRST_FOUND=false
          for i in $(seq 1 $TIMEOUT_SECONDS); do
            if grep -q $GREP_OPTIONS "$EXPECTED_OUTPUT" "$LOGFILE"; then
              FIRST_FOUND=true
              echo "‚úÖ Âú® $i ÁßíÂêéÊ£ÄÊµãÂà∞Á¨¨‰∏Ä‰∏™ '$EXPECTED_OUTPUT' ËæìÂá∫"
              break
            fi
            sleep 1
          done
          
          if [ "$FIRST_FOUND" = "false" ]; then
            echo "‚ùå ÈîôËØØÔºöÂú® ${TIMEOUT_SECONDS}ÁßíÂÜÖÊú™Ê£ÄÊµãÂà∞Á¨¨‰∏Ä‰∏™ '$EXPECTED_OUTPUT' ËæìÂá∫"
            echo "=== ÊúÄÂêé${LOG_LINES_ON_FAILURE}Ë°åËæìÂá∫ ==="
            tail -$LOG_LINES_ON_FAILURE "$LOGFILE"
            kill -9 $SIM_PID 2>/dev/null || true
            rm -f "$LOGFILE"
            exit 1
          fi
          
          # ËÆ∞ÂΩïÂºÄÂßãÁõëÊéßÁöÑÊó∂Èó¥
          START_TIME=$(date +%s)
          echo "ÂºÄÂßãÁõëÊéßÊó∂Èó¥: $(date -d @$START_TIME)"
          echo "Â∞ÜÂú® ${MONITOR_SECONDS} ÁßíÂêéÊ£ÄÊü•ËæìÂá∫Êï∞Èáè"
          
          # Á≠âÂæÖÊåáÂÆöÁöÑÁõëÊéßÊó∂Èïø
          sleep $MONITOR_SECONDS
          
          END_TIME=$(date +%s)
          ELAPSED=$((END_TIME - START_TIME))
          echo "ÁõëÊéßÁªìÊùüÊó∂Èó¥: $(date -d @$END_TIME)"
          echo "ÁõëÊéßÊó∂Èïø: ${ELAPSED}Áßí"
          
          # ÁªìÊùü‰ªøÁúüËøõÁ®ã
          echo -e "\n=== ÁªìÊùü‰ªøÁúüËøõÁ®ã ==="
          kill -9 $SIM_PID 2>/dev/null || true
          wait $SIM_PID 2>/dev/null || true
          
          # ÁªüËÆ°ËæìÂá∫‰∏≠EXPECTED_OUTPUTÁöÑÊï∞Èáè
          if [ "$OUTPUT_CASE_SENSITIVE" = "true" ]; then
            COUNT=$(grep -c "$EXPECTED_OUTPUT" "$LOGFILE")
          else
            COUNT=$(grep -ic "$EXPECTED_OUTPUT" "$LOGFILE")
          fi
          
          echo "Ê£ÄÊµãÂà∞ '$EXPECTED_OUTPUT' ÁöÑËæìÂá∫Êï∞Èáè: $COUNT"
          
          # Ê£ÄÊü•Êï∞ÈáèÊòØÂê¶Âú®ÊúüÊúõËåÉÂõ¥ÂÜÖ
          IS_VALID=false
          for expected in $EXPECTED_COUNT_RANGE; do
            if [ "$COUNT" -eq "$expected" ]; then
              IS_VALID=true
              break
            fi
          done
          
          if [ "$IS_VALID" = "true" ]; then
            echo "‚úÖ ÊàêÂäüÔºöÂú® ${MONITOR_SECONDS} ÁßíÁõëÊéßÊúüÂÜÖÊ£ÄÊµãÂà∞ $COUNT ‰∏™ '$EXPECTED_OUTPUT' ËæìÂá∫ÔºåÁ¨¶ÂêàÈ¢ÑÊúüÔºà${EXPECTED_COUNT_RANGE}Ôºâ"
            echo "=== ÂåÖÂê´ '$EXPECTED_OUTPUT' ÁöÑÊâÄÊúâËæìÂá∫Ë°å ==="
            grep $GREP_OPTIONS "$EXPECTED_OUTPUT" "$LOGFILE"
            rm -f "$LOGFILE"
            exit 0
          else
            echo "‚ùå ÈîôËØØÔºöÂú® ${MONITOR_SECONDS} ÁßíÁõëÊéßÊúüÂÜÖÊ£ÄÊµãÂà∞ $COUNT ‰∏™ '$EXPECTED_OUTPUT' ËæìÂá∫Ôºå‰∏çÁ¨¶ÂêàÈ¢ÑÊúüÔºà${EXPECTED_COUNT_RANGE}Ôºâ"
            echo "=== ÊúÄÂêé${LOG_LINES_ON_FAILURE}Ë°åËæìÂá∫ ==="
            tail -$LOG_LINES_ON_FAILURE "$LOGFILE"
            rm -f "$LOGFILE"
            exit 1
          fi

#      - name: hello
#        run: |
#          KEY=$(head -c 5 /dev/urandom | base32)
#          make -C $YSYX_HOME/npc run ALL=hello
#          python $YSYX_HOME/monitor.py --middle="Hello World!" --good=$KEY make -C $YSYX_HOME/npc run mainargs=$KEY

  hello:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: Debug monitor.py
        run: |
          echo "=== Ë∞ÉËØï‰ø°ÊÅØ ==="
          pwd
          ls -la
          
          echo -e "\n=== Êü•Êâæ monitor.py ==="
          find . -name "monitor.py" 2>/dev/null
          
          echo -e "\n=== ÁéØÂ¢ÉÂèòÈáè ==="
          env | grep -i "monitor\|ysyx"
          
          echo -e "\n=== ÈÖçÁΩÆÂèòÈáè ==="
          echo "EXPECTED_OUTPUT: $EXPECTED_OUTPUT"
          echo "OUTPUT_CASE_SENSITIVE: $OUTPUT_CASE_SENSITIVE"
          echo "TIMEOUT_SECONDS: $TIMEOUT_SECONDS"
          
          echo -e "\n=== Ê£ÄÊü• YSYX_HOME ==="
          ls -la "$YSYX_HOME/" 2>/dev/null | head -10

      - name: hello
        run: |
          KEY=$(head -c 5 /dev/urandom | base32)
          python $MONITOR_PY --middle="Hello, AbstractMachine!" --good=$KEY make ARCH=minirv-npc -C $YSYX_HOME/am-kernels/kernels/hello run mainargs=$KEY

  mario:
    needs: setup
    runs-on: ubuntu-22.04
    env:
      # ÈÖçÁΩÆÂèòÈáè
      EXPECTED_OUTPUT: "FPS"  # Ë¶ÅÊ£ÄÊµãÁöÑËæìÂá∫Â≠óÁ¨¶‰∏≤ÔºàFPSÔºâ
      OUTPUT_CASE_SENSITIVE: true  # ÊòØÂê¶Âå∫ÂàÜÂ§ßÂ∞èÂÜô
      MARIO_RUN_SECONDS: 10800  # ÊúÄÂ§ßËøêË°åÊó∂Èïø3Â∞èÊó∂ÔºàÁßíÔºâ
      TIMEOUT_SECONDS: 10900  # ÊÄª‰ΩìË∂ÖÊó∂Êó∂Èó¥ÔºàÁßíÔºâÔºåÊØîËøêË°åÊó∂ÈïøÂ§ö‰∏Ä‰∫õ
      LOG_LINES_ON_FAILURE: 100  # Â§±Ë¥•Êó∂ÊòæÁ§∫ÁöÑÊúÄÂêéÊó•ÂøóË°åÊï∞
      LOG_LINES_ON_SUCCESS: 20  # ÊàêÂäüÊó∂ÊòæÁ§∫ÁöÑÂåÖÂê´FPSÁöÑË°åÊï∞
      CHECK_INTERVAL: 5  # Ê£ÄÊü•FPSÁöÑÊó∂Èó¥Èó¥ÈöîÔºàÁßíÔºâ

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: mario
        run: |
          echo "ÂºÄÂßãËøêË°åmarioÊµãËØï..."
          echo "ÈÖçÁΩÆ:"
          echo "  - È¢ÑÊúüËæìÂá∫: '$EXPECTED_OUTPUT' (FPS)"
          echo "  - Â§ßÂ∞èÂÜôÊïèÊÑü: $OUTPUT_CASE_SENSITIVE"
          echo "  - ÊúÄÂ§ßËøêË°åÊó∂Èïø: ${MARIO_RUN_SECONDS}Áßí ($((MARIO_RUN_SECONDS/3600))Â∞èÊó∂)"
          echo "  - Ê£ÄÊü•Èó¥Èöî: ${CHECK_INTERVAL}Áßí"
          
          # ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂Êñá‰ª∂Êù•ËÆ∞ÂΩïËæìÂá∫
          LOGFILE="/tmp/npc_mario_$$.log"
          PIDFILE="/tmp/npc_mario_$$.pid"
          
          # Ê†πÊçÆÂ§ßÂ∞èÂÜôÊïèÊÑüËÆæÁΩÆÈÄâÊã©grepÈÄâÈ°π
          if [ "$OUTPUT_CASE_SENSITIVE" = "true" ]; then
            GREP_OPTIONS=""
            echo "Ê£ÄÊµãÊ®°Âºè: Âå∫ÂàÜÂ§ßÂ∞èÂÜô"
          else
            GREP_OPTIONS="-i"
            echo "Ê£ÄÊµãÊ®°Âºè: ‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜô"
          fi
          
          echo -e "\n=== ÂêØÂä®È©¨ÈáåÂ••‰ªøÁúüËøõÁ®ã ==="
          
          # ËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥
          START_TIME=$(date +%s)
          MAX_END_TIME=$((START_TIME + MARIO_RUN_SECONDS))
          echo "ÂºÄÂßãÊó∂Èó¥: $(date -d @$START_TIME)"
          echo "ÊúÄÊôöÁªìÊùüÊó∂Èó¥: $(date -d @$MAX_END_TIME)"
          
          # ÂêØÂä®‰ªøÁúüËøõÁ®ãÔºåÂπ∂Â∞ÜËæìÂá∫ÈáçÂÆöÂêëÂà∞Êó•ÂøóÊñá‰ª∂ÂíåÊéßÂà∂Âè∞
          make IMG=$YSYX_HOME/fceux-minirv-npc.bin -C $NPC_HOME run mainargs=mario 2>&1 | tee "$LOGFILE" &
          SIM_PID=$!
          
          # ‰øùÂ≠òPID‰ª•‰æøÂêéÁª≠Ê∏ÖÁêÜ
          echo $SIM_PID > "$PIDFILE"
          echo "È©¨ÈáåÂ••‰ªøÁúüËøõÁ®ãPID: $SIM_PID"
          
          FPS_FOUND=false
          EARLY_EXIT=false
          
          echo -e "\n=== ÁõëÊéßÈ©¨ÈáåÂ••ËæìÂá∫ÔºåÂØªÊâæFPS ==="
          echo "Â∞ÜÂú®${MARIO_RUN_SECONDS}ÁßíÂÜÖÊåÅÁª≠ÁõëÊéßÔºå‰∏ÄÊó¶Ê£ÄÊµãÂà∞FPSÁ´ãÂç≥ÊàêÂäüÈÄÄÂá∫"
          echo "Ê£ÄÊü•Èó¥Èöî: ÊØè${CHECK_INTERVAL}Áßí"
          
          # ÁõëÊéßÂæ™ÁéØ
          CURRENT_TIME=$(date +%s)
          while [ $CURRENT_TIME -lt $MAX_END_TIME ]; do
            # Ê£ÄÊü•ËøõÁ®ãÊòØÂê¶ËøòÂú®ËøêË°å
            if ! kill -0 $SIM_PID 2>/dev/null; then
              echo "‚ö†Ô∏è È©¨ÈáåÂ••ËøõÁ®ãÂ∑≤ÊèêÂâçÈÄÄÂá∫"
              EARLY_EXIT=true
              break
            fi
            
            # Ê£ÄÊü•Êó•Âøó‰∏≠ÊòØÂê¶ÂåÖÂê´FPS
            if grep -q $GREP_OPTIONS "$EXPECTED_OUTPUT" "$LOGFILE"; then
              echo "‚úÖ Ê£ÄÊµãÂà∞ '$EXPECTED_OUTPUT' ËæìÂá∫ÔºÅ"
              FPS_FOUND=true
              break
            fi
            
            # Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥ÂÜçÊ£ÄÊü•
            sleep $CHECK_INTERVAL
            CURRENT_TIME=$(date +%s)
            
            # ÊòæÁ§∫ËøõÂ∫¶
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((MAX_END_TIME - CURRENT_TIME))
            if [ $((ELAPSED % 60)) -eq 0 ]; then
              echo "Â∑≤ËøêË°å: ${ELAPSED}ÁßíÔºåÂâ©‰Ωô: ${REMAINING}Áßí"
            fi
          done
          
          # ËÆ∞ÂΩïÁªìÊùüÊó∂Èó¥
          END_TIME=$(date +%s)
          ACTUAL_RUN_TIME=$((END_TIME - START_TIME))
          
          echo -e "\n=== Ê∏ÖÁêÜ‰ªøÁúüËøõÁ®ã ==="
          if [ -f "$PIDFILE" ]; then
            PID_TO_KILL=$(cat "$PIDFILE")
            kill -9 $PID_TO_KILL 2>/dev/null || true
            rm -f "$PIDFILE"
          fi
          
          # ÁªôËøõÁ®ã‰∏ÄÁÇπÊó∂Èó¥ÂÆåÂÖ®ÈÄÄÂá∫
          sleep 2
          
          echo -e "\n=== ÊµãËØïÁªìÊûú ==="
          echo "ÂºÄÂßãÊó∂Èó¥: $(date -d @$START_TIME)"
          echo "ÁªìÊùüÊó∂Èó¥: $(date -d @$END_TIME)"
          echo "ÂÆûÈôÖËøêË°åÊó∂Èïø: ${ACTUAL_RUN_TIME}Áßí"
          
          if [ "$FPS_FOUND" = "true" ]; then
            echo "‚úÖ ÊàêÂäüÔºöÂú® ${ACTUAL_RUN_TIME} ÁßíÂÜÖÊ£ÄÊµãÂà∞ '$EXPECTED_OUTPUT' ËæìÂá∫"
            echo "=== ÊúÄÂêé${LOG_LINES_ON_SUCCESS}Ë°åÂåÖÂê´FPSÁöÑËæìÂá∫ ==="
            grep $GREP_OPTIONS "$EXPECTED_OUTPUT" "$LOGFILE" | tail -$LOG_LINES_ON_SUCCESS
            echo -e "\n=== ÊµãËØïÁªüËÆ° ==="
            echo "FPSÂá∫Áé∞Ê¨°Êï∞: $(grep -c $GREP_OPTIONS "$EXPECTED_OUTPUT" "$LOGFILE")"
            rm -f "$LOGFILE"
            exit 0
          elif [ "$EARLY_EXIT" = "true" ]; then
            echo "‚ùå ÈîôËØØÔºöÈ©¨ÈáåÂ••ËøõÁ®ãÊèêÂâçÈÄÄÂá∫ÔºåËøêË°å ${ACTUAL_RUN_TIME} ÁßíÂêéÊú™Ê£ÄÊµãÂà∞ '$EXPECTED_OUTPUT'"
            echo "=== ÊúÄÂêé${LOG_LINES_ON_FAILURE}Ë°åËæìÂá∫ ==="
            tail -$LOG_LINES_ON_FAILURE "$LOGFILE"
            rm -f "$LOGFILE"
            exit 1
          else
            echo "‚ùå ÈîôËØØÔºöÂú® ${ACTUAL_RUN_TIME} ÁßíÂÜÖÊú™Ê£ÄÊµãÂà∞ '$EXPECTED_OUTPUT' ËæìÂá∫"
            echo "=== ÊúÄÂêé${LOG_LINES_ON_FAILURE}Ë°åËæìÂá∫ ==="
            tail -$LOG_LINES_ON_FAILURE "$LOGFILE"
            rm -f "$LOGFILE"
            exit 1
          fi

  cpu-tests:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: cpu-tests
        run: |
          make ARCH=minirv-npc -C $YSYX_HOME/am-kernels/tests/cpu-tests run -j1
# make ARCH=minirv-npc -C $YSYX_HOME/am-kernels/tests/cpu-tests run ALL=dummy

  riscv-tests:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-tests
        run: |
          git clone --depth 1 https://github.com/NJU-ProjectN/riscv-tests-am
          make ARCH=minirv-npc -C riscv-tests-am run TEST_ISA=i -j1
#make ARCH=minirv-npc -C riscv-tests-am run TEST_ISA=i ALL=auipc

  # riscv-arch-test:
  #   needs: setup
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Common operations
  #       uses: ./.github/actions/common
  #       with:
  #         YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
  #         cache-key: ${{ needs.setup.outputs.cache-key }}
  #         MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

  #     - name: riscv-arch-test
  #       run: |
  #         git clone --depth 1 https://github.com/NJU-ProjectN/riscv-arch-test-am
  #         make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=add-01
  #         make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA="E"

####################################################################
  riscv-arch-test-add-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=add-01

  riscv-arch-test-addi-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=addi-01

  riscv-arch-test-and-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=and-01

  riscv-arch-test-andi-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=andi-01

  riscv-arch-test-auipc-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=auipc-01

  riscv-arch-test-beq-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=beq-01

  riscv-arch-test-bge-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=bge-01

  riscv-arch-test-bgeu-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=bgeu-01

  riscv-arch-test-blt-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=blt-01

  riscv-arch-test-bltu-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=bltu-01

  riscv-arch-test-bne-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=bne-01

  riscv-arch-test-jal-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=jal-01

  riscv-arch-test-jalr-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=jalr-01

  riscv-arch-test-lb-align-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=lb-align-01

  riscv-arch-test-lbu-align-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=lbu-align-01

  riscv-arch-test-lh-align-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=lh-align-01

  riscv-arch-test-lhu-align-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=lhu-align-01

  riscv-arch-test-lui-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=lui-01

  riscv-arch-test-lw-align-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=lw-align-01

  riscv-arch-test-or-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=or-01

  riscv-arch-test-ori-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=ori-01

  riscv-arch-test-sb-align-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=sb-align-01

  riscv-arch-test-sh-align-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=sh-align-01

  riscv-arch-test-sll-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=sll-01

  riscv-arch-test-slli-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=slli-01

  riscv-arch-test-slt-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=slt-01

  riscv-arch-test-slti-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=slti-01

  riscv-arch-test-sltiu-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=sltiu-01

  riscv-arch-test-sltu-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=sltu-01

  riscv-arch-test-sra-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=sra-01

  riscv-arch-test-srai-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=srai-01

  riscv-arch-test-srl-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=srl-01

  riscv-arch-test-srli-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=srli-01

  riscv-arch-test-sub-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=sub-01

  riscv-arch-test-sw-align-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=sw-align-01

  riscv-arch-test-xor-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=xor-01

  riscv-arch-test-xori-01:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: riscv-arch-test
        run: |
          make ARCH=minirv-npc -C riscv-arch-test-am run TEST_ISA=E ALL=xori-01

####################################################################
  microbench:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: microbench
        run: |
          KEY=$(head -c 5 /dev/urandom | base32)
          python $MONITOR_PY --good="$KEY" make ARCH=minirv-npc -C $YSYX_HOME/am-kernels/benchmarks/microbench run mainargs=$KEY

  # rt-thread:
  #   needs: setup
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Common operations
  #       uses: ./.github/actions/common
  #       with:
  #         YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
  #         cache-key: ${{ needs.setup.outputs.cache-key }}
  #         MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

  #     - name: Install dependency
  #       run: sudo apt install -y scons

  #     - name: rt-thread
  #       run: |
  #         cd $YSYX_HOME/rt-thread-am/bsp/abstract-machine
  #         make ARCH=riscv32e-ysyxsoc init
  #         KEY=$(head -c 5 /dev/urandom | base32)
  #         python $YSYX_HOME/monitor.py --good=$KEY make ARCH=riscv32e-ysyxsoc run

  iverilog-microbench:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: compile microbench
        run: |
          make ARCH=minirv-npc -C $YSYX_HOME/am-kernels/benchmarks/microbench mainargs=the_insert-arg_rule_in_Makefile_will_insert_mainargs_here

      - name: run microbench with iverilog
        run: |
          make -C $NPC_HOME clean
          KEY=$(head -c 5 /dev/urandom | base32)
          IMG=$YSYX_HOME/am-kernels/benchmarks/microbench/build/microbench-minirv-npc.bin
          python $AM_HOME/tools/insert-arg.py $IMG 64 the_insert-arg_rule_in_Makefile_will_insert_mainargs_here $KEY
          python $MONITOR_PY --good=$KEY make -C $NPC_HOME sim-iverilog IMG=$IMG

  yosys-sta:
    needs: [parse, setup]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}
          install-toolchain: 'false'

      - name: Install dependency
        run: |
          sudo apt install -y libunwind-dev liblzma-dev

      - name: Clone yosys-sta
        run: |
          git clone -b ci https://github.com/OSCPU/yosys-sta
          cd yosys-sta
          make init
          echo exit | ./bin/iEDA -v

      # - name: Generate Verilog
      #   run: |
      #     make -C $NPC_HOME verilog

      - name: Set environment variables
        run: |
          echo "STUID=${{ needs.parse.outputs.STUID }}" >> $GITHUB_ENV
          echo "VFILE=${{ needs.setup.outputs.VFILE }}" >> $GITHUB_ENV

      - name: Run STA
        run: |
          make -C yosys-sta sta DESIGN=ysyx_$STUID CLK_FREQ_MHZ=500 CLK_PORT_NAME=clock RTL_FILES=$VFILE

      - name: Check verilog module name
        run: |
          YOSYS_LOG=yosys-sta/result/ysyx_$STUID-500MHz/yosys.log
          LINE=`grep -n "Successfully finished Verilog frontend" $YOSYS_LOG | head -n 1 | grep -o '^[0-9]*'`
          if head -n $LINE $YOSYS_LOG | grep "Generating RTLIL representation for module" | grep -v "ysyx_$STUID" ; then
            echo "There exist modules which do not start with ysyx_$STUID"
            false
          fi

      - name: Check latch
        run: |
          YOSYS_LOG=yosys-sta/result/ysyx_$STUID-500MHz/synth_stat.txt
          if grep "DLL\|DLH" $YOSYS_LOG ; then
            echo "The design contains latch, which is not allowed."
            false
          fi
###Èù¢ÁßØ
      # - name: Parse area
      #   run: |
      #     YOSYS_LOG=yosys-sta/result/ysyx_$STUID-500MHz/yosys-fixed.log
      #     AREA=`grep -o "Chip area for module .*: .*" $YOSYS_LOG | sed -e 's/.*: \([0-9]*\.[0-9]*\)$/\1/'`
      #     if [[ $AREA == "" ]] ; then
      #       echo "Can not obtain area from yosys-sta. Abort."
      #       false
      #     fi
      #     echo "Area: $AREA"
      #     echo "AREA=$AREA" >> $GITHUB_ENV

      # - name: Run STA with older version
      #   run: |
      #     cd yosys-sta
      #     git config --global user.email "ci@ysyx.org"
      #     git config --global user.name "ysyx-ci"
      #     git revert --no-edit 97fa7fcb80de4966c6f390af8df1b37d6d4c42c8
      #     make clean
      #     make sta DESIGN=ysyx_$STUID CLK_FREQ_MHZ=500 CLK_PORT_NAME=clock RTL_FILES=$VFILE

      # - name: Parse area with older version
      #   run: |
      #     YOSYS_LOG=yosys-sta/result/ysyx_$STUID-500MHz/yosys-fixed.log
      #     AREA_OLD=`grep -o "Chip area for module .*: .*" $YOSYS_LOG | sed -e 's/.*: \([0-9]*\.[0-9]*\)$/\1/'`
      #     if [[ $AREA_OLD == "" ]] ; then
      #       echo "Can not obtain area from yosys-sta. Abort."
      #       false
      #     fi
      #     echo "Area: $AREA_OLD"
      #     echo "AREA_OLD=$AREA_OLD" >> $GITHUB_ENV

      # - name: Check area
      #   run: |
      #     AREA_BUDGET=16500
      #     AREA_OLD_BUDGET=25000
      #     if [[ $AREA -gt $AREA_BUDGET ]] ; then
      #       if [[ $AREA_OLD -gt $AREA_OLD_BUDGET ]] ; then
      #         echo "Area($AREA) is larger than the budget($AREA_BUDGET)."
      #         echo "Area for old version of yosys-sta($AREA_OLD) is larger than the budget($AREA_OLD_BUDGET)."
      #         false
      #       fi
      #     fi
###
      - name: Upload netlist file
        uses: actions/upload-artifact@v4
        with:
          name: netlist
          path: yosys-sta/result/ysyx_${{ needs.parse.outputs.STUID }}-500MHz/ysyx_${{ needs.parse.outputs.STUID }}.netlist.fixed.v

  iverilog-netlist-microbench:
    needs: [parse, setup, yosys-sta]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Common operations
        uses: ./.github/actions/common
        with:
          YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
          cache-key: ${{ needs.setup.outputs.cache-key }}
          MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}

      - name: Download verilog file
        uses: actions/download-artifact@v4
        with:
          name: netlist

      - name: Clone yosys-sta
        run: |
          git clone -b ci https://github.com/OSCPU/yosys-sta
          cd yosys-sta
          make init
          echo exit | ./bin/iEDA -v

      - name: compile microbench
        run: |
          make ARCH=minirv-npc -C $YSYX_HOME/am-kernels/benchmarks/microbench mainargs=the_insert-arg_rule_in_Makefile_will_insert_mainargs_here

      - name: run microbench with iverilog netlist
        run: |
          make -C $NPC_HOME clean
          NETLIST=`pwd`/ysyx_${{ needs.parse.outputs.STUID }}.netlist.fixed.v
          CELLS=`pwd`/yosys-sta/pdk/nangate45/sim/cells.v
          KEY=$(head -c 5 /dev/urandom | base32)
          IMG=$YSYX_HOME/am-kernels/benchmarks/microbench/build/microbench-minirv-npc.bin
          python $AM_HOME/tools/insert-arg.py $IMG 64 the_insert-arg_rule_in_Makefile_will_insert_mainargs_here $KEY
          python $MONITOR_PY --good=$KEY make -C $NPC_HOME sim-iverilog-netlist IMG=$IMG NETLIST=$NETLIST CELLS=$CELLS

  # more-tests:
  #   needs: [setup, hello, time, mario, cpu-tests, riscv-tests, microbench]
  #   runs-on: self-hosted
  #   steps:
  #     - name: Download verilog file
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: verilog
  #     - name: More tests
  #       run: |
  #         VFILE=`basename "${{ needs.setup.outputs.VFILE }}"`
  #         bash ../../../more-tests.sh `realpath $VFILE`

  # push-code:
  #   needs: [parse, setup, more-tests]
  #   runs-on: ubuntu-22.04
  #   permissions:
  #     contents: write  # ÂÖ≥ÈîÆÔºöÊéà‰∫àÂÜôÂÖ•ÊùÉÈôê
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Common operations
  #       uses: ./.github/actions/common
  #       with:
  #         YSYX_HOME: ${{ needs.setup.outputs.YSYX_HOME }}
  #         cache-key: ${{ needs.setup.outputs.cache-key }}
  #         MAKEFLAGS: ${{ needs.setup.outputs.MAKEFLAGS }}
  #         install-toolchain: 'false'

  #     - name: Set Git user and email
  #       run: |
  #         git config --global user.email "ci@ysyx.org"
  #         git config --global user.name "ysyx-ci"

  #     - name: Fetch target branch
  #       run: |
  #         pwd
  #         git remote add local file://$YSYX_HOME
  #         git fetch local tmp-ci:tmp-ci
  #         git checkout tmp-ci
  #         git checkout master .github
  #         git reset HEAD .github

  #     - name: Add info
  #       run: |
  #         echo "" >> README.md
  #         echo "STUID - ysyx_${{ needs.parse.outputs.STUID }}" >> README.md
  #         echo "" >> README.md
  #         echo "Original repo - ${{ needs.parse.outputs.REPO }}" >> README.md
  #         echo "" >> README.md
  #         echo "Original branch - ${{ needs.parse.outputs.BRANCH }}" >> README.md
  #         git add -f README.md
  #         git commit -m "add original info"

  #     - name: Add exam script
  #       run: |
  #         mkdir ysyx-ci
  #         cd ysyx-ci
  #         echo "empty" > init-exam.sh
  #         git add -f init-exam.sh
  #         git commit -m "add init-exam.sh"

  #     - name: Add result git tracer
  #       run: |
  #         cd $YSYX_HOME
  #         git log -u tracer-ysyx > tracer.log
  #         tar cj tracer.log > tracer.tar.bz2
  #         rm tracer.log
  #         cd -
  #         mv $YSYX_HOME/tracer.tar.bz2 ysyx-ci/
  #         git add -f ysyx-ci/tracer.tar.bz2
  #         git commit -m "add tracer.tar.bz2"

  #     - name: Push code
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         git push origin HEAD:ysyx_${{ needs.parse.outputs.STUID }}

  # finish:
  #   needs: [parse, setup, more-tests]
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - name: Comment the issue
  #       uses: peter-evans/create-or-update-comment@v4
  #       with:
  #         issue-number: ${{ github.event.issue.number }}
  #         comment-id: ${{ needs.parse.outputs.COMMENT_ID }}
  #         body: |
  #           Finish
  #         edit-mode: append

  #     - name: Close the issue
  #       uses: peter-evans/close-issue@v2
  #       with:
  #         issue-number: ${{ github.event.issue.number }}

  # error-handler:
  #   runs-on: ubuntu-22.04
  #   needs: [parse, setup, time, mario, hello, cpu-tests, riscv-tests, microbench, more-tests]
  #   if: ${{ failure() }}
  #   steps:
  #     - name: Comment the issue
  #       uses: peter-evans/create-or-update-comment@v4
  #       with:
  #         issue-number: ${{ github.event.issue.number }}
  #         comment-id: ${{ needs.parse.outputs.COMMENT_ID }}
  #         body: |
  #           End with errors
  #         edit-mode: append

